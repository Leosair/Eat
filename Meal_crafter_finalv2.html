<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Meal Summary</title>
    <style>
        /* --- 1. Base Styles --- */
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            background-image: url("Images/Background.png");
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- 2. Card Container --- */
        .card-container {
            background: white;
            width: 90%;
            max-width: 380px;
            max-height: 90dvh; 
            padding: 1.5rem;
            border-radius: 20px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* --- 3. Header / Plate Area --- */
        .plate-display {
            text-align: center;
            margin-bottom: 1rem;
            flex-shrink: 0;
        }

        .plate-image-box {
            width: 100%;
            height: 200px;
            background-color: #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #dee2e6;
            margin-bottom: 0.5rem;
        }

        #result-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        #placeholder-text {
            color: #adb5bd;
            font-weight: 600;
            padding: 1rem;
        }

        .status-text {
            font-size: 0.95rem;
            color: #495057;
            margin: 0;
            min-height: 1.2em;
            font-weight: 500;
        }

        /* --- 4. Scrolling Lists --- */
        .scroll-area {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 5px;
            margin-bottom: 1rem;
            /* Smooth fade in */
            animation: fadeIn 0.4s ease-in-out;
        }

        .scroll-area::-webkit-scrollbar { width: 6px; }
        .scroll-area::-webkit-scrollbar-thumb { background-color: #ccc; border-radius: 4px; }

        /* --- 5. Selection Items --- */
        .option-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .option-item.selected {
            background-color: #e6fcf5;
            border-color: #20c997;
        }

        .option-label { font-weight: 600; color: #495057; }

        .check-circle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid #adb5bd;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
        }

        .option-item.selected .check-circle {
            background: #20c997;
            border-color: #20c997;
        }

        .check-circle::after {
            content: '✔';
            font-size: 14px;
            color: white;
            display: none;
        }

        .option-item.selected .check-circle::after { display: block; }
        .hidden-checkbox { display: none; }

        /* --- 6. Buttons --- */
        .btn-primary {
            width: 100%;
            padding: 15px;
            background-color: #339af0;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            margin-top: 5px;
        }
        
        .btn-primary:disabled { background-color: #adb5bd; cursor: not-allowed; }

        .btn-finish {
            background-color: #20c997; /* Green for finish */
        }

        .btn-machine {
            background-color: #ff6b6b; /* Salmon for final CTA */
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 10px rgba(255, 107, 107, 0.3);
            margin-top: 1.5rem;
        }

        /* --- 7. Nutrition Summary Styles --- */
        .nutrition-container {
            background-color: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-top: 10px;
        }

        .nutrition-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            text-align: center;
        }

        .nutri-item {
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .nutri-val {
            display: block;
            font-size: 1.2rem;
            font-weight: 800;
            color: #333;
        }

        .nutri-label {
            font-size: 0.8rem;
            color: #868e96;
            text-transform: uppercase;
        }

        .summary-header {
            font-size: 1.1rem;
            font-weight: 700;
            color: #343a40;
            margin-bottom: 5px;
            text-align: center;
        }

        .summary-sub {
            font-size: 0.9rem;
            color: #495057;
            text-align: center;
            margin-bottom: 20px;
            font-style: italic;
        }

        /* Utilities */
        .hidden { display: none !important; }
        .section-title { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; color: #868e96; margin-bottom: 10px; display: block; }
        .warning-msg { color: #e03131; font-size: 0.85rem; height: 20px; margin-top: 5px; opacity: 0; transition: opacity 0.2s; text-align: center; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

                /* Prevent any horizontal scrollbar caused by children (safe guard) */
        html, body {
            overflow-x: hidden;
        }

        /* Make sure the card itself never forces overflow */
        .card-container {
            box-sizing: border-box;   /* include padding in width */
            overflow-x: hidden;       /* hide any tiny overflow caused by shadows etc */
        }

        /* Make the CTA button behave and not exceed the card width */
        .btn-machine {
            display: block;           /* ensure block-level sizing */
            width: 100%;              /* fit the card width exactly */
            max-width: 100%;          /* never grow bigger than card */
            box-sizing: border-box;   /* include padding/border in width calc */
            white-space: normal;      /* allow wrapping of long text */
            word-wrap: break-word;    /* fallback wrap */
            overflow-wrap: anywhere;  /* break long words/URLs if needed */
            margin-left: 0;           /* remove accidental negative/auto margins */
            margin-right: 0;
        }

        /* Optional: make big shadows not cause overflow (keeps same visual) */
        .btn-machine {
            /* keep your shadow but ensure it won't expand layout */
            box-shadow: 0 4px 10px rgba(255, 107, 107, 0.3);
            /* if you still see overflow, reduce blur/spread here slightly */
        }

    </style>
</head>
<body>

    <div class="card-container">
        
        <div class="plate-display" id="main-plate-display">
            <div class="plate-image-box">
                <img id="result-img" src="Images/0.png" alt="Combined Meal" style="display:block;">
                <div id="placeholder-text" style="display:none">Select ingredients<br>(Min 2, Max 4)</div>
            </div>
            <p class="status-text" id="status-display">0 selections made</p>
            <div class="warning-msg" id="warning-msg">Maximum 4 items allowed!</div>
        </div>

        <div id="stage-1" class="scroll-area">
            <span class="section-title">Step 1: Build your plate</span>

            <label class="option-item" id="row-1">
                <span class="option-label">Clean pasta</span>
                <div class="check-circle"></div>
                <input type="checkbox" class="hidden-checkbox stage-1-input" value="1" onchange="updatePlate()">
            </label>

            <label class="option-item" id="row-2">
                <span class="option-label">Corn with butter</span>
                <div class="check-circle"></div>
                <input type="checkbox" class="hidden-checkbox stage-1-input" value="2" onchange="updatePlate()">
            </label>

            <label class="option-item" id="row-3">
                <span class="option-label">Peas with carrot</span>
                <div class="check-circle"></div>
                <input type="checkbox" class="hidden-checkbox stage-1-input" value="3" onchange="updatePlate()">
            </label>

            <label class="option-item" id="row-4">
                <span class="option-label">Vegan meat (Seitan)</span>
                <div class="check-circle"></div>
                <input type="checkbox" class="hidden-checkbox stage-1-input" value="4" onchange="updatePlate()">
            </label>

            <label class="option-item" id="row-5">
                <span class="option-label">Mashed potatoes</span>
                <div class="check-circle"></div>
                <input type="checkbox" class="hidden-checkbox stage-1-input" value="5" onchange="updatePlate()">
            </label>
            
            <button class="btn-primary" id="cont-btn" onclick="goToStage2()" disabled>Continue</button>
            
            <div style="text-align:center; margin-top:20px;">
                <button onclick="location.href='index.html'" style="background:none; border:none; color:#adb5bd; text-decoration:underline; cursor:pointer;">← Back to Home</button>
            </div>
        </div>

        <div id="stage-2" class="scroll-area hidden">
            <span class="section-title">Step 2: Add Modifiers</span>

            <label class="option-item" id="row-mod-1">
                <span class="option-label">Add Vitamins</span>
                <div class="check-circle"></div>
                <input type="checkbox" class="hidden-checkbox stage-2-input" value="Add Vitamins" onchange="updateSummary()">
            </label>

            <label class="option-item" id="row-mod-2">
                <span class="option-label">Add Protein</span>
                <div class="check-circle"></div>
                <input type="checkbox" class="hidden-checkbox stage-2-input" value="Add Protein" onchange="updateSummary()">
            </label>

            <label class="option-item" id="row-mod-3">
                <span class="option-label">Low Salt</span>
                <div class="check-circle"></div>
                <input type="checkbox" class="hidden-checkbox stage-2-input" value="Low Salt" onchange="updateSummary()">
            </label>

            <label class="option-item" id="row-mod-4">
                <span class="option-label">Low Carbs</span>
                <div class="check-circle"></div>
                <input type="checkbox" class="hidden-checkbox stage-2-input" value="Low Carbs" onchange="updateSummary()">
            </label>

            <label class="option-item" id="row-mod-5">
                <span class="option-label">No Gluten</span>
                <div class="check-circle"></div>
                <input type="checkbox" class="hidden-checkbox stage-2-input" value="No Gluten" onchange="updateSummary()">
            </label>

            <button class="btn-primary btn-finish" onclick="goToStage3()">Finish</button>

            <div style="text-align:center; margin-top:20px;">
                <button onclick="location.href='index.html'" style="background:none; border:none; color:#adb5bd; text-decoration:underline; cursor:pointer;">← Back to Home</button>
            </div>
        </div>

        <div id="stage-3" class="scroll-area hidden">
            <span class="section-title" style="text-align:center;">Your Perfect Meal</span>
            
            <div class="summary-header" id="final-combo-name">Combo Name</div>
            <div class="summary-sub" id="final-modifiers">No modifiers</div>

            <div class="nutrition-container">
                <div class="nutrition-grid">
                    <div class="nutri-item">
                        <span class="nutri-val" id="val-cals">0</span>
                        <span class="nutri-label">Calories</span>
                    </div>
                    <div class="nutri-item">
                        <span class="nutri-val" id="val-protein">0g</span>
                        <span class="nutri-label">Protein</span>
                    </div>
                    <div class="nutri-item">
                        <span class="nutri-val" id="val-carbs">0g</span>
                        <span class="nutri-label">Carbs</span>
                    </div>
                    <div class="nutri-item">
                        <span class="nutri-val" id="val-fat">0g</span>
                        <span class="nutri-label">Fat</span>
                    </div>
                </div>
            </div>

            <a href="#" class="btn-primary btn-machine" style="text-decoration:none; display:flex; align-items:center; justify-content:center; text-align:center;">
                Search for your
                closest machine!
            </a>

            <div style="text-align:center; margin-top:20px;">
                <button onclick="location.reload()" style="background:none; border:none; color:#adb5bd; text-decoration:underline; cursor:pointer;">Start Over</button>
            </div>

            <div style="text-align:center; margin-top:20px;">
                <button onclick="location.href='index.html'" style="background:none; border:none; color:#adb5bd; text-decoration:underline; cursor:pointer;">← Back to Home</button>
            </div>

        </div>

    </div>

    <script>
        // --- DATA ---
        const ingredientNames = { 1: "Pasta", 2: "Corn", 3: "Peas", 4: "Seitan", 5: "M.Potatoes" };

        // 1. INTRINSIC VALUES FOR COMBINATIONS
        // The key is the sorted IDs joined by underscore.
        // If a combination isn't here, we calculate a default sum.
        const baseNutritionDB = {
            "1_2": { cals: 350, pro: 35, carbs: 10, fat: 15 }, // Protein + Veg (Keto-ish)
            "1_3": { cals: 550, pro: 30, carbs: 60, fat: 12 }, // Protein + Carbs (Bulking)
            "1_2_3": { cals: 600, pro: 38, carbs: 65, fat: 18 }, // Balanced
            "2_3_4": { cals: 400, pro: 8,  carbs: 70, fat: 10 }, // Veggie Pasta/Rice
            "1_2_3_4": { cals: 750, pro: 40, carbs: 80, fat: 25 }, // The Full Meal
            // Default "Individual" values to sum up if combo not found above
            "single_vals": {
                1: { cals: 200, pro: 25, carbs: 0, fat: 10 },
                2: { cals: 50,  pro: 2,  carbs: 8, fat: 0 },
                3: { cals: 250, pro: 5,  carbs: 50, fat: 2 },
                4: { cals: 100, pro: 0,  carbs: 10, fat: 8 },
                5: { cals: 80,  pro: 1,  carbs: 5,  fat: 6 }
            }
        };

        // 2. MODIFIERS (Deltas)
        const modifierDB = {
            "Add Vitamins": { cals: 0, pro: 0, carbs: 0, fat: 0 }, // Just vitamins
            "Add Protein":  { cals: 60, pro: 15, carbs: 0, fat: 0 },
            "Low Salt":     { cals: 0, pro: 0, carbs: 0, fat: 0 },
            "Low Carbs":    { cals: -80, pro: 0, carbs: -20, fat: 0 }, // Removes rice/pasta portion
            "No Gluten":    { cals: 0, pro: 0, carbs: 0, fat: 0 }
        };

        // Global State
        let currentSelectedIds = [];
        let currentSelectedModifiers = [];

        // --- STAGE 1 LOGIC ---
        function updatePlate() {
            const checkboxes = document.querySelectorAll('.stage-1-input');
            const resultImg = document.getElementById('result-img');
            const placeholder = document.getElementById('placeholder-text');
            const statusDisplay = document.getElementById('status-display');
            const warningMsg = document.getElementById('warning-msg');
            const contBtn = document.getElementById('cont-btn');

            let selectedIds = [];
            checkboxes.forEach(box => {
                const row = document.getElementById('row-' + box.value);
                if (box.checked) {
                    selectedIds.push(box.value);
                    row.classList.add('selected');
                } else {
                    row.classList.remove('selected');
                }
            });

            if (selectedIds.length === 0) {
                resultImg.src = "Images/0.png";
                resultImg.style.display = "block";
                placeholder.style.display = "none";
                statusDisplay.innerText = "0 selections made";
                contBtn.disabled = true;
                return;
            }

            // Check Max 4
            if (selectedIds.length > 4) {
                const lastId = selectedIds.pop();
                document.querySelector(`.stage-1-input[value="${lastId}"]`).checked = false;
                document.getElementById('row-' + lastId).classList.remove('selected');
                warningMsg.style.opacity = '1';
                setTimeout(() => { warningMsg.style.opacity = '0'; }, 2000);
            }

            // Update State
            currentSelectedIds = selectedIds;
            statusDisplay.innerText = `${selectedIds.length} selections made`;

            // Valid selection?
            if (selectedIds.length >= 2) {
                contBtn.disabled = false;
                
                // Image Logic (UPDATED to match /Images folder and your naming convention)
                selectedIds = selectedIds.map(s => Number(s));
                selectedIds.sort((a,b) => a - b);
                const count = selectedIds.length;
                const filePart = selectedIds.join('.');
                const imagePath = `Images/${count}_${filePart}.png`;

                // Try to load the image; if not found, show placeholder again
                resultImg.src = imagePath;
                resultImg.style.display = 'block';
                placeholder.style.display = 'none';

                // fallback handling: if the image fails to load, show placeholder and hide img
                resultImg.onerror = function() {
                    resultImg.style.display = 'none';
                    placeholder.style.display = 'flex';
                };

                // If it loads successfully, ensure placeholder is hidden (onload)
                resultImg.onload = function() {
                    resultImg.style.display = 'block';
                    placeholder.style.display = 'none';
                };

            } else {
                resultImg.src = "Images/0.png";
                resultImg.style.display = 'block';
                placeholder.style.display = 'none';
            }
        }

        // --- TRANSITIONS ---
        function goToStage2() {
            document.getElementById('stage-1').classList.add('hidden');
            document.getElementById('stage-2').classList.remove('hidden');
            updateSummary(); // Refresh text
        }

        function goToStage3() {
            calculateFinalNutrition();

            document.getElementById('stage-2').classList.add('hidden');
            document.getElementById('main-plate-display').classList.add('hidden'); // Hide the image/header
            document.getElementById('stage-3').classList.remove('hidden');
        }

        // --- STAGE 2 LOGIC ---
        function updateSummary() {
            const checkboxes = document.querySelectorAll('.stage-2-input');
            const statusDisplay = document.getElementById('status-display');

            let modifiers = [];
            checkboxes.forEach(box => {
                const row = box.parentElement;
                if (box.checked) {
                    modifiers.push(box.value);
                    row.classList.add('selected');
                } else {
                    row.classList.remove('selected');
                }
            });
            
            currentSelectedModifiers = modifiers;

            // Update Text
            let baseNames = currentSelectedIds.map(id => ingredientNames[id]).join(" + ");
            let text = baseNames;
            if (modifiers.length > 0) text += " — " + modifiers.join(", ");
            statusDisplay.innerText = text;
        }

        // --- STAGE 3 CALCULATION ---
        function calculateFinalNutrition() {
            currentSelectedIds.sort();
            const comboKey = currentSelectedIds.join("_");

            // 1. Get Base Nutrition
            let baseStats = { cals: 0, pro: 0, carbs: 0, fat: 0 };

            if (baseNutritionDB[comboKey]) {
                // If specific combo exists in DB, use it
                baseStats = { ...baseNutritionDB[comboKey] }; // Clone object
            } else {
                // Otherwise, sum up individual parts (Fallback logic)
                currentSelectedIds.forEach(id => {
                    const vals = baseNutritionDB.single_vals[id];
                    baseStats.cals += vals.cals;
                    baseStats.pro += vals.pro;
                    baseStats.carbs += vals.carbs;
                    baseStats.fat += vals.fat;
                });
            }

            // 2. Apply Modifiers
            currentSelectedModifiers.forEach(modName => {
                const modStats = modifierDB[modName];
                if (modStats) {
                    baseStats.cals += modStats.cals;
                    baseStats.pro += modStats.pro;
                    baseStats.carbs += modStats.carbs;
                    baseStats.fat += modStats.fat;
                }
            });

            // 3. Render Text
            const baseNames = currentSelectedIds.map(id => ingredientNames[id]).join(" + ");
            document.getElementById('final-combo-name').innerText = baseNames;
            
            const modText = currentSelectedModifiers.length > 0 
                ? currentSelectedModifiers.join(", ") 
                : "No modifiers added";
            document.getElementById('final-modifiers').innerText = modText;

            // 4. Render Numbers (prevent negatives)
            document.getElementById('val-cals').innerText = Math.max(0, baseStats.cals);
            document.getElementById('val-protein').innerText = Math.max(0, baseStats.pro) + "g";
            document.getElementById('val-carbs').innerText = Math.max(0, baseStats.carbs) + "g";
            document.getElementById('val-fat').innerText = Math.max(0, baseStats.fat) + "g";
        }
    </script>
</body>
</html>
